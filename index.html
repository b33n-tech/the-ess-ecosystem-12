let quizQuestions = [
  { question: "O√π en √™tes-vous de votre projet aujourd'hui ?", options: ["Je n'ai qu'une id√©e", "Je teste d√©j√†", "Je suis lanc√©"] },
  { question: "Quel type de besoin avez-vous ?", options: ["Financement", "Accompagnement", "Outils"] },
  { question: "Quel est le secteur de votre projet ?", options: ["ESS", "Tech", "Autre"] }
];

let currentStep = 0;
let userAnswers = [];
let offresData = [];

// --- CHARGEMENT DATA ---
async function loadData() {
  try {
    const response = await fetch('data.json');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    offresData = [...data.ponctuels, ...data.stables, ...data.outils];
    renderOffres(offresData);
  } catch (err) {
    console.error("Erreur chargement data.json :", err);
    // Afficher un message d'erreur √† l'utilisateur
    const container = document.getElementById('offresContainer');
    if (container) {
      container.innerHTML = `<div class="empty-state"><h3>‚ö†Ô∏è Erreur de chargement</h3><p>Impossible de charger les donn√©es. Veuillez r√©essayer.</p></div>`;
    }
  }
}

// --- RENDER QUIZ ---
function renderQuizStep() {
  const questionObj = quizQuestions[currentStep];
  const questionText = document.getElementById('questionText');
  const quizOptions = document.getElementById('quizOptions');
  
  if (!questionText || !quizOptions) return;
  
  questionText.textContent = questionObj.question;
  quizOptions.innerHTML = "";

  questionObj.options.forEach((opt) => {
    const div = document.createElement('div');
    div.className = 'quiz-option';
    div.textContent = opt;
    if (userAnswers[currentStep] === opt) {
      div.classList.add('selected');
    }
    div.addEventListener('click', () => {
      userAnswers[currentStep] = opt;
      document.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
      div.classList.add('selected');
    });
    quizOptions.appendChild(div);
  });

  // Boutons
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  
  if (btnPrev) {
    btnPrev.disabled = currentStep === 0;
  }
  if (btnNext) {
    btnNext.textContent = currentStep === quizQuestions.length - 1 ? 'Terminer ‚úÖ' : 'Suivant ‚Üí';
  }

  // Progress bar
  const progressFill = document.getElementById('progressFill');
  const currentStepEl = document.getElementById('currentStep');
  const totalStepsEl = document.getElementById('totalSteps');
  
  if (progressFill) {
    const progressPercent = Math.round(((currentStep + 1) / quizQuestions.length) * 100);
    progressFill.style.width = progressPercent + '%';
  }
  if (currentStepEl) {
    currentStepEl.textContent = currentStep + 1;
  }
  if (totalStepsEl) {
    totalStepsEl.textContent = quizQuestions.length;
  }
}

// --- NAVIGATION ---
function initNavigation() {
  const btnNext = document.getElementById('btnNext');
  const btnPrev = document.getElementById('btnPrev');
  
  if (btnNext) {
    btnNext.addEventListener('click', () => {
      if (!userAnswers[currentStep]) {
        alert("Veuillez s√©lectionner une option !");
        return;
      }
      if (currentStep < quizQuestions.length - 1) {
        currentStep++;
        renderQuizStep();
      } else {
        const quizContainer = document.querySelector('.quiz-container');
        const resultsSection = document.getElementById('resultsSection');
        
        if (quizContainer) quizContainer.style.display = 'none';
        if (resultsSection) resultsSection.style.display = 'block';
        
        filterOffresByQuiz();
      }
    });
  }
  
  if (btnPrev) {
    btnPrev.addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        renderQuizStep();
      }
    });
  }
}

// --- FILTRAGE OFFRES ---
function filterOffresByQuiz() {
  if (!offresData || offresData.length === 0) {
    renderOffres([]);
    return;
  }
  
  // Si pas de r√©ponses, afficher toutes les offres
  if (userAnswers.length === 0) {
    renderOffres(offresData);
    return;
  }
  
  let filtered = offresData.filter(offre => {
    // V√©rifier que l'offre a des tags
    if (!offre.tags || !Array.isArray(offre.tags)) return false;
    
    // Pour chaque r√©ponse utilisateur, v√©rifier si au moins un tag correspond
    let matchCount = 0;
    userAnswers.forEach(answer => {
      const answerLower = answer.toLowerCase().trim();
      const hasMatch = offre.tags.some(tag => {
        const tagLower = tag.toLowerCase();
        // Extraire la valeur apr√®s les ":" si pr√©sent
        const tagValue = tagLower.includes(':') 
          ? tagLower.split(':')[1].trim() 
          : tagLower;
        
        // V√©rifier la correspondance exacte ou partielle
        return tagValue === answerLower || 
               tagValue.includes(answerLower) || 
               answerLower.includes(tagValue);
      });
      if (hasMatch) matchCount++;
    });
    
    // Retourner les offres qui correspondent √† TOUS les crit√®res
    return matchCount === userAnswers.length;
  });
  
  // Si aucun r√©sultat avec tous les crit√®res, essayer avec au moins 2 sur 3
  if (filtered.length === 0 && userAnswers.length >= 2) {
    filtered = offresData.filter(offre => {
      if (!offre.tags || !Array.isArray(offre.tags)) return false;
      let matchCount = 0;
      userAnswers.forEach(answer => {
        const answerLower = answer.toLowerCase().trim();
        const hasMatch = offre.tags.some(tag => {
          const tagLower = tag.toLowerCase();
          const tagValue = tagLower.includes(':') 
            ? tagLower.split(':')[1].trim() 
            : tagLower;
          return tagValue === answerLower || 
                 tagValue.includes(answerLower) || 
                 answerLower.includes(tagValue);
        });
        if (hasMatch) matchCount++;
      });
      return matchCount >= 2;
    });
  }
  
  // Si toujours aucun r√©sultat, essayer avec au moins 1 match
  if (filtered.length === 0) {
    filtered = offresData.filter(offre => {
      if (!offre.tags || !Array.isArray(offre.tags)) return false;
      return userAnswers.some(answer => {
        const answerLower = answer.toLowerCase().trim();
        return offre.tags.some(tag => {
          const tagLower = tag.toLowerCase();
          const tagValue = tagLower.includes(':') 
            ? tagLower.split(':')[1].trim() 
            : tagLower;
          return tagValue === answerLower || 
                 tagValue.includes(answerLower) || 
                 answerLower.includes(tagValue);
        });
      });
    });
  }
  
  // Si toujours aucun r√©sultat, afficher toutes les offres
  if (filtered.length === 0) {
    console.log("Aucune offre ne correspond exactement, affichage de toutes les offres");
    filtered = offresData;
  }
  
  console.log(`Filtrage: ${filtered.length} offre(s) trouv√©e(s) sur ${offresData.length}`);
  renderOffres(filtered);
}

// --- RENDER OFFRES ---
function renderOffres(offres) {
  const container = document.getElementById('offresContainer');
  if (!container) return;
  
  if (!offres || offres.length === 0) {
    container.innerHTML = `<div class="empty-state"><h3>Aucune offre trouv√©e</h3><p>Essayez de modifier vos crit√®res ou revenir plus tard.</p></div>`;
    return;
  }
  
  container.innerHTML = "";
  
  offres.forEach(o => {
    const card = document.createElement('div');
    card.className = 'offre-card';
    
    // Construction des tags
    const tagsHtml = o.tags && Array.isArray(o.tags) 
      ? o.tags.map(t => {
          const tagValue = t.split(':')[1] || t;
          return `<span class="meta-tag">${tagValue}</span>`;
        }).join('')
      : '';
    
    const regionHtml = o.region 
      ? `<span class="meta-tag">üìç ${o.region}</span>` 
      : '';
    
    card.innerHTML = `
      <h3>${o.title || 'Sans titre'}</h3>
      <div class="offre-meta">
        ${tagsHtml}
        ${regionHtml}
      </div>
      <p class="offre-description">${o.description || ''}</p>
      <div class="offre-actions">
        <a href="${o.url || '#'}" target="_blank" rel="noopener noreferrer" style="color: var(--primary, #007bff); text-decoration: none; font-size: 14px;">En savoir plus ‚Üí</a>
        <button class="btn-icon" data-title="${o.title || ''}">‚ù§Ô∏è Ajouter</button>
      </div>
    `;
    container.appendChild(card);
  });

  // Wishlist boutons
  attachWishlistListeners();
}

// --- WISHLIST ---
function attachWishlistListeners() {
  document.querySelectorAll('.btn-icon').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const currentCount = parseInt(document.getElementById('wishlistCount')?.textContent || '0');
      updateWishlistCount(currentCount + 1);
      
      // Feedback visuel
      btn.textContent = '‚úÖ Ajout√©';
      btn.disabled = true;
      btn.style.opacity = '0.6';
    });
  });
}

function updateWishlistCount(count) {
  const wishlistCountEl = document.getElementById('wishlistCount');
  if (wishlistCountEl) {
    wishlistCountEl.textContent = count;
  }
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  renderQuizStep();
  initNavigation();
  updateWishlistCount(0);
});
